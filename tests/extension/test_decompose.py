from unittest import TestCase

from shapely.extension.geometry.straight_segment import StraightSegment
from shapely.extension.util.decompose import decompose
from shapely.geometry import MultiPolygon, box, Point, LineString, GeometryCollection, MultiPoint, Polygon, \
    LinearRing
from shapely.wkt import loads


class DecomposeTest(TestCase):
    def test_decompose_multipolygon_to_point(self):
        multipolygon = MultiPolygon([box(0, 0, 1, 1), box(1, 1, 2, 2)])
        points = decompose(multipolygon, target_class=Point)
        self.assertTrue(all(isinstance(geom, Point) for geom in points))
        self.assertEqual(10, len(points))

    def test_decompose_multipolygon_to_linestring(self):
        multipolygon = MultiPolygon([box(0, 0, 1, 1), box(1, 1, 2, 2)])
        lines = decompose(multipolygon, target_class=LineString)
        self.assertTrue(all(isinstance(geom, LineString) for geom in lines))
        self.assertEqual(2, len(lines))

    def test_decompose_geometry_collection_to_point(self):
        # each box has 5 points, including extra point equal to the first point
        geom_col = GeometryCollection([MultiPolygon([box(0, 0, 1, 1), box(1, 1, 2, 2)]),
                                       Point(0, 1),
                                       LineString([(1, 1), (2, 2)])])
        points = decompose(geom_col, target_class=Point)

        self.assertTrue(all(isinstance(geom, Point) for geom in points))
        self.assertEqual(13, len(points))

    def test_falsy_case_of_decomposing_multipoint_to_polygon(self):
        multipoint = MultiPoint([Point(0, 0), Point(1, 1)])
        result = decompose(multipoint, target_class=Polygon)
        self.assertTrue(isinstance(result, list))
        self.assertEqual(0, len(result))

        result = decompose(multipoint, target_class=Polygon, remaining_low_dim_obj=True)
        self.assertTrue(isinstance(result, list))
        self.assertEqual(1, len(result))
        self.assertEqual(multipoint, result[0])

    def test_decompose_linestring_to_segment(self):
        linestring = LineString([(0, 0), (1, 1), (2, 1), (2, 3), (5, 3)])
        segments = linestring.ext.decompose(StraightSegment).to_list()
        self.assertEqual(len(segments), 4)

        linearring = LinearRing([(0, 0), (1, 1), (2, 1), (2, 3), (5, 3), (5, 0), (0, 0)])
        segments = linearring.ext.decompose(StraightSegment).to_list()
        self.assertEqual(len(segments), 6)

    def test_for_geometry_collection_that_might_deduce_wrong_type_obj(self):
        geom_col = loads(
            'GEOMETRYCOLLECTION (LINESTRING (-46.76048274504859 -58.02365464666233, -46.760482745062546 -81.39902694066939), LINESTRING (-46.760482745062546 -81.39902694066939, -46.760482745065474 -86.3052427512306), LINESTRING (167.11190749051747 100.37599125736213, 167.11190749051747 76.16331276910591), LINESTRING (167.11190749051747 76.16331276910591, 167.11190749051747 53.52899035926066), LINESTRING (167.11190749051747 53.52899035926066, 167.11190749051747 45.97006550358055), LINESTRING (167.11190749051747 45.97006550358055, 167.11190749051747 7.9934975879051535), LINESTRING (167.11190749051747 7.9934975879051535, 167.11190749051747 7.993497587904153), LINESTRING (84.48832571044548 -47.96856510590658, 84.48832571044449 -47.96856510590658), LINESTRING (84.48832571044449 -47.96856510590658, 63.000604107070444 -47.96856510590658), LINESTRING (63.000604107070444 -47.96856510590658, 30.488900976571585 -47.96856510590658), LINESTRING (30.488900976571585 -47.96856510590658, -10.82072060871991 -47.96856510590658), LINESTRING (-10.82072060871991 -47.96856510590658, -46.477246113215664 -47.96856510590658), LINESTRING (167.11190749051747 76.16331276910591, 195.8439462853754 76.16331276910591), LINESTRING (28.22477051197352 83.60617381052134, 1.558263812758014 83.60617381052134), LINESTRING (1.558263812758014 83.60617381052134, -17.459832096454534 83.60617381052134), LINESTRING (-17.459832096454534 83.60617381052134, -17.459832096455532 83.60617381052134), LINESTRING (-28.51054998116158 53.52899035926066, -17.459832096454534 53.52899035926066), LINESTRING (-17.459832096454534 53.52899035926066, 1.558263812758014 53.52899035926066), LINESTRING (1.558263812758014 53.52899035926066, 37.03055496003236 53.52899035926066), LINESTRING (37.03055496003236 53.52899035926066, 61.01412975064949 53.52899035926066), LINESTRING (61.01412975064949 53.52899035926066, 96.60981899376247 53.52899035926066), LINESTRING (96.60981899376247 53.52899035926066, 114.1439587511374 53.52899035926066), LINESTRING (114.1439587511374 53.52899035926066, 149.87653595910143 53.52899035926066), LINESTRING (149.87653595910143 53.52899035926066, 167.11190749051747 53.52899035926066), LINESTRING (-46.760482745062546 -81.39902694066939, -10.168017005746648 -81.39902694066939), LINESTRING (114.1439587511384 90.61450397963347, 114.1439587511374 90.61450397963347), LINESTRING (114.1439587511374 90.61450397963347, 96.60981899376247 90.61450397963347), LINESTRING (96.60981899376247 90.61450397963347, 63.09970168991765 90.61450397963347), LINESTRING (196.07546411617648 7.9934975879051535, 167.86054985508264 7.9934975879051535), LINESTRING (167.86054985508264 7.9934975879051535, 167.11190749051747 7.9934975879051535), LINESTRING (167.11190749051747 7.9934975879051535, 135.34883580834259 7.9934975879051535), LINESTRING (135.34883580834259 7.9934975879051535, -32.27866782722854 7.9934975879051535), LINESTRING (135.34883580834358 -19.07175947788585, 135.34883580834259 -19.07175947788585), LINESTRING (135.34883580834259 -19.07175947788585, 117.00002884094334 -19.07175947788585), LINESTRING (117.00002884094334 -19.07175947788585, 84.48832571044449 -19.07175947788585), LINESTRING (84.48832571044449 -19.07175947788585, -46.47724611319841 -19.07175947788585), LINESTRING (84.48832571044449 -19.07175947788585, 84.48832571044449 -47.96856510590658), LINESTRING (84.48832571044449 -47.96856510590658, 84.48832571044449 -50.67944955467233), LINESTRING (135.34883580834259 7.9934975879051535, 135.34883580834259 -19.07175947788585), LINESTRING (135.34883580834259 -19.07175947788585, 135.34883580834259 -23.936797460054116), LINESTRING (96.60981899376247 53.52899035926066, 96.60981899376247 90.61450397963347), LINESTRING (1.558263812758014 83.60617381052134, 1.558263812758014 53.52899035926066), LINESTRING (-17.459832096454534 53.52899035926066, -17.459832096454534 63.83662483518685), LINESTRING (-17.459832096454534 63.83662483518685, -17.459832096454534 83.60617381052134), LINESTRING (-17.459832096454534 83.60617381052134, -17.459832096454534 93.35883704889046), LINESTRING (149.87653595910143 53.52899035926066, 149.87653595910143 100.37599125736209), LINESTRING (114.1439587511374 100.37599125736199, 114.1439587511374 90.61450397963347), LINESTRING (114.1439587511374 90.61450397963347, 114.1439587511374 53.52899035926066), LINESTRING (37.03055496003236 53.52899035926066, 37.03055496003236 81.09599126002446), LINESTRING (-79.78917802654956 -94.73231197988562, -79.78917802654956 -60.9234371748705), LINESTRING (30.488900976571585 -47.96856510590658, 30.488900976571585 -72.83506217995031), LINESTRING (195.8439462853754 45.970065503580535, 167.11190749051747 45.97006550358055), LINESTRING (61.01412975064949 83.62424099166654, 61.01412975064949 53.52899035926066), LINESTRING (-10.82072060871991 -75.57647846233051, -10.82072060871991 -47.96856510590658), LINESTRING (-32.717649925116085 63.83662483518685, -17.459832096454534 63.83662483518685), LINESTRING (167.86054985508264 -6.842012998039528, 167.86054985508264 -6.842012998039527), LINESTRING (167.86054985508264 -6.842012998039527, 167.86054985508264 7.9934975879051535), LINESTRING (117.00002884094334 -33.584670832459466, 117.00002884094334 -19.07175947788585), LINESTRING (63.000604107070444 -61.97777633194922, 63.000604107070444 -47.96856510590658), LINESTRING (33.978900552661536 -79.45841037844457, 39.55958260374268 -79.45841037844457), POINT (47.05232435637698 -79.45841037844457))')
        result = geom_col.ext.decompose(LineString).to_list()
        self.assertTrue(all(isinstance(item, LineString) for item in result))

    def test_keep_direction_from_polygon_to_straight_segments(self):
        ccw_polygon = Polygon(([(0, 0), (10, 0), (20, 14), (10, 20), (0, 0)]))
        cw_polygon = Polygon(([(0, 0), (10, 20), (20, 14), (10, 0), (0, 0)]))
        ccw_decomposed_segments = decompose(ccw_polygon, target_class=StraightSegment)
        cw_decomposed_segments = decompose(cw_polygon, target_class=StraightSegment)
        ccw_lines = [StraightSegment([(0, 0), (10, 0)]),
                     StraightSegment([(10, 0), (20, 14)]),
                     StraightSegment([(20, 14), (10, 20)]),
                     StraightSegment([(10, 20), (0, 0)])]
        cw_lines = [StraightSegment([(0, 0), (10, 20)]),
                    StraightSegment([(10, 20), (20, 14)]),
                    StraightSegment([(20, 14), (10, 0)]),
                    StraightSegment([(10, 0), (0, 0)])]
        self.assertTrue(all([ccw_decomposed_segments[i] == ccw_lines[i] for i in range(len(ccw_lines))]))
        self.assertTrue(all([cw_decomposed_segments[i] == cw_lines[i] for i in range(len(cw_lines))]))

    def test_decompose_invalid_linear_ring_to_point(self):
        ring = LinearRing([(0, 0), (0.5, 0), (0.5, 0.5), (0.5, 0), (1, 0), (1, 1), (0, 1), (0, 0)])
        points = decompose(ring, target_class=Point)
        self.assertEqual(8, len(points))