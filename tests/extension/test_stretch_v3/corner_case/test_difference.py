import pytest

from shapely.extension.model.stretch.stretch_v3 import Stretch
from shapely.wkt import loads


@pytest.fixture
def stretch_001() -> Stretch:
    return Stretch.loads(
        '{"pivot": {"0": [92.31915327871684, -38.57981466401761], "1": [85.23110575345538, -48.28052531032034], "2": [88.94527514099784, -50.99436866627208], "3": [100.3226862140171, -35.42322974102079], "4": [100.07724563705044, -19.069095381862297], "5": [29.063786142848386, 67.56562128728115], "6": [22.838028905293953, 62.46244121804599], "7": [92.07031501737946, -21.9992866628117], "8": [-56.82559511282135, -84.5120309482116], "9": [-56.82559511282135, -75.46889094629766], "10": [-64.87559511282134, -75.46889094629766], "11": [-64.87559511282134, -88.19965593768666], "12": [-56.86552160072714, -95.10789094634957], "13": [3.063253666841149, -95.10789094634958], "14": [24.80852280472205, -93.55927089900766], "15": [56.7257477755937, -83.51050936479754], "16": [74.24192955054343, -71.11738570288767], "17": [85.18204293715145, -56.14473293438149], "18": [78.68224650895228, -51.39550706146604], "19": [68.51836248168101, -65.30581136470896], "20": [53.10557433998788, -76.21073298912333], "21": [23.293234811899897, -85.59679618753923], "22": [2.776970140774438, -87.05789094634959], "23": [-53.873679650910596, -87.05789094634959], "24": [-35.49956963233092, 116.59210905365087], "25": [-21.531423919931616, 116.59210905365086], "26": [2.9589083631809534, 86.71449129509254], "27": [9.184665600735372, 91.8176713643277], "28": [-17.721140361240273, 124.64210905365086], "29": [-39.40576071780106, 124.64210905365087], "30": [-64.87559511282146, 92.31157236118835], "31": [-64.87559511282142, 72.67481803511708], "32": [-56.82559511282142, 72.67481803511708], "33": [-56.82559511282142, 89.52158167573472], "34": [-56.825595112821375, -51.79689094627836], "35": [-56.825595112821375, -12.816892268426528], "36": [-64.87559511282137, -12.816892268426528], "37": [-64.87559511282137, -51.79689094627836], "38": [-64.8755951128214, 6.803250884145122], "39": [-56.825595112821404, 6.803250884145122], "40": [-56.825595112821404, 50.20281793866988], "41": [-64.8755951128214, 50.20281793866988], "68": [81.134529696606, -8.657890967293724], "74": [-18.925595152037992, -87.05789094634957], "79": [45.87440484796201, -78.48738134765505], "80": [45.87440484796201, -8.657890967293724], "81": [13.474404847962006, -8.657890967293724], "83": [-48.26184825220687, 100.39210905365088], "85": [-18.92559515203797, 100.39210905365088], "86": [-8.252474232827545, 100.39210905365088], "90": [13.474404847962006, 35.84210905402929], "92": [44.65840245220607, 35.84210905402929], "102": [-18.925595152038, -36.007890943994425], "103": [-56.82559511282136, -36.00789094399437], "104": [-18.925595152037992, 31.09210905600539], "105": [-56.82559511282139, 31.09210905600539], "106": [13.474404847962006, 31.09210905600539]}, "pivot_cargo": {"0": {}, "1": {}, "2": {}, "3": {}, "4": {}, "5": {}, "6": {}, "7": {}, "8": {}, "9": {}, "10": {}, "11": {}, "12": {}, "13": {}, "14": {}, "15": {}, "16": {}, "17": {}, "18": {}, "19": {}, "20": {}, "21": {}, "22": {}, "23": {}, "24": {}, "25": {}, "26": {}, "27": {}, "28": {}, "29": {}, "30": {}, "31": {}, "32": {}, "33": {}, "34": {}, "35": {}, "36": {}, "37": {}, "38": {}, "39": {}, "40": {}, "41": {}, "68": {}, "74": {}, "79": {}, "80": {}, "81": {}, "83": {}, "85": {}, "86": {}, "90": {}, "92": {}, "102": {}, "103": {}, "104": {}, "105": {}, "106": {}}, "edge_cargo": {"(0,1)": {"width": 1.9, "is_fixed": true, "is_starting": false}, "(1,2)": {"width": 0, "is_fixed": true, "is_starting": false}, "(2,3)": {"width": 0, "is_fixed": true, "is_starting": false}, "(3,4)": {"width": 0, "is_fixed": true, "is_starting": false}, "(4,5)": {"width": 0, "is_fixed": true, "is_starting": false}, "(5,6)": {"width": 0, "is_fixed": true, "is_starting": false}, "(7,0)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(8,9)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(9,10)": {"width": 0, "is_fixed": true, "is_starting": false}, "(10,11)": {"width": 0, "is_fixed": true, "is_starting": false}, "(11,12)": {"width": 0, "is_fixed": true, "is_starting": false}, "(12,13)": {"width": 0, "is_fixed": true, "is_starting": false}, "(13,14)": {"width": 0, "is_fixed": true, "is_starting": false}, "(14,15)": {"width": 0, "is_fixed": true, "is_starting": false}, "(15,16)": {"width": 0, "is_fixed": true, "is_starting": false}, "(16,17)": {"width": 0, "is_fixed": true, "is_starting": false}, "(17,18)": {"width": 0, "is_fixed": true, "is_starting": false}, "(18,19)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(23,8)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(26,27)": {"width": 0, "is_fixed": true, "is_starting": false}, "(27,28)": {"width": 0, "is_fixed": true, "is_starting": false}, "(28,29)": {"width": 0, "is_fixed": true, "is_starting": false}, "(29,30)": {"width": 0, "is_fixed": true, "is_starting": false}, "(30,31)": {"width": 0, "is_fixed": true, "is_starting": false}, "(31,32)": {"width": 0, "is_fixed": true, "is_starting": false}, "(35,36)": {"width": 0, "is_fixed": true, "is_starting": false}, "(36,37)": {"width": 0, "is_fixed": true, "is_starting": false}, "(37,34)": {"width": 0, "is_fixed": true, "is_starting": false}, "(38,39)": {"width": 0, "is_fixed": true, "is_starting": false}, "(40,41)": {"width": 0, "is_fixed": true, "is_starting": false}, "(41,38)": {"width": 0, "is_fixed": true, "is_starting": false}, "(10,9)": {"width": 0, "is_fixed": true, "is_starting": false}, "(9,8)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(8,23)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(19,18)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(18,17)": {"width": 0, "is_fixed": true, "is_starting": false}, "(2,1)": {"width": 0, "is_fixed": true, "is_starting": false}, "(1,0)": {"width": 3.6, "is_fixed": true, "is_starting": false}, "(0,7)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(6,5)": {"width": 0, "is_fixed": true, "is_starting": false}, "(27,26)": {"width": 0, "is_fixed": true, "is_starting": false}, "(32,31)": {"width": 0, "is_fixed": true, "is_starting": false}, "(31,41)": {"width": 0, "is_fixed": false, "is_starting": false}, "(41,40)": {"width": 0, "is_fixed": true, "is_starting": false}, "(39,38)": {"width": 0, "is_fixed": true, "is_starting": false}, "(38,36)": {"width": 0, "is_fixed": false, "is_starting": false}, "(36,35)": {"width": 0, "is_fixed": true, "is_starting": false}, "(34,37)": {"width": 0, "is_fixed": true, "is_starting": false}, "(37,10)": {"width": 0, "is_fixed": false, "is_starting": false}, "(68,7)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(7,68)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(21,22)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(22,21)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(24,25)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(25,24)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(17,2)": {"width": 0, "is_fixed": false, "is_starting": false}, "(22,74)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(74,22)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(20,79)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(79,21)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(21,79)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(79,20)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(79,80)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(80,79)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(33,83)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(83,24)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(24,83)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(83,33)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(25,86)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(86,26)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(26,86)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(86,25)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(85,86)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(86,85)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(92,68)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(68,92)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(19,20)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(20,19)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(74,23)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(23,74)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(32,33)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(33,32)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(6,92)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(92,6)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(68,80)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(80,68)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(83,85)": {"width": 2.75, "is_fixed": false, "is_starting": true}, "(85,83)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(80,81)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(81,80)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(92,90)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(90,92)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(5,27)": {"width": 0, "is_fixed": false, "is_starting": false}, "(102,103)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(103,102)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(104,105)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(105,104)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(81,106)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(106,90)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(90,106)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(106,81)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(106,104)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(104,106)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(34,103)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(103,34)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(103,35)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(35,103)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(39,105)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(105,39)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(105,40)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(40,105)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(74,102)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(102,74)": {"width": 2.75, "is_fixed": false, "is_starting": true}, "(104,85)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(85,104)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(104,102)": {"width": 2.75, "is_fixed": false, "is_starting": false}, "(102,104)": {"width": 2.75, "is_fixed": false, "is_starting": false}}, "closure": {"1": {"exterior": ["10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "79", "21", "22", "74", "23", "8", "9", "10"], "interiors": []}, "2": {"exterior": ["24", "25", "86", "26", "27", "28", "29", "30", "31", "32", "33", "83", "24"], "interiors": []}, "3": {"exterior": ["34", "103", "35", "36", "37", "34"], "interiors": []}, "4": {"exterior": ["38", "39", "105", "40", "41", "38"], "interiors": []}, "6": {"exterior": ["0", "1", "2", "3", "4", "5", "6", "92", "68", "7", "0"], "interiors": []}, "114": {"exterior": ["0", "7", "68", "80", "79", "20", "19", "18", "17", "2", "1", "0"], "interiors": []}, "125": {"exterior": ["24", "83", "85", "86", "25", "24"], "interiors": []}, "140": {"exterior": ["80", "68", "92", "90", "106", "81", "80"], "interiors": []}, "164": {"exterior": ["10", "9", "8", "23", "74", "102", "103", "34", "37", "10"], "interiors": []}, "167": {"exterior": ["104", "85", "83", "33", "32", "31", "41", "40", "105", "104"], "interiors": []}, "169": {"exterior": ["74", "22", "21", "79", "80", "81", "106", "104", "102", "74"], "interiors": []}, "170": {"exterior": ["104", "106", "90", "92", "6", "5", "27", "26", "86", "85", "104"], "interiors": []}, "172": {"exterior": ["102", "104", "105", "39", "38", "36", "35", "103", "102"], "interiors": []}}, "closure_cargo": {"1": {"angle": 0, "region_type": "surrounding", "clamp": false, "seen0baeced2-a353-49": true}, "2": {"angle": 0, "region_type": "surrounding", "clamp": false, "seen0baeced2-a353-49": true}, "3": {"angle": 0, "region_type": "surrounding", "clamp": false, "seen0baeced2-a353-49": true}, "4": {"angle": 0, "region_type": "surrounding", "clamp": false, "seen0baeced2-a353-49": true}, "6": {"angle": 0, "region_type": "surrounding", "clamp": false, "seen0baeced2-a353-49": true}, "114": {"angle": 90, "region_type": "building", "clamp": false, "seen0baeced2-a353-49": true}, "125": {"angle": 0.0, "region_type": "core", "clamp": false, "seen0baeced2-a353-49": true}, "140": {"angle": 90, "region_type": "building", "clamp": false, "seen0baeced2-a353-49": true}, "164": {"angle": 90, "region_type": "building", "clamp": false, "seen0baeced2-a353-49": false}, "167": {"angle": 90, "region_type": "building", "clamp": false, "seen0baeced2-a353-49": false}, "169": {"angle": 90, "region_type": "core", "clamp": false, "seen0baeced2-a353-49": false}, "170": {"angle": 90, "region_type": "building", "clamp": false, "seen0baeced2-a353-49": false}, "172": {"angle": 90, "region_type": "building", "clamp": false, "seen0baeced2-a353-49": false}}}')


def test_difference_without_lefting_0_width_convex_part(stretch_001):
    stretch = stretch_001

    closure = stretch.closures[9]
    removing_part = loads(
        'MULTIPOLYGON (((-18.925595152038 -36.007890943994404, -56.82559511282136 -36.007890943994404, -56.82559511282137 -20.507890943994425, -18.925595152038 -20.507890943994425, -18.925595152038 -36.007890943994404)), ((-56.82559511282139 31.09210905600539, -56.8255951128214 43.94210905600539, -18.92559515203799 43.94210905600539, -18.925595152037992 31.09210905600539, -56.82559511282139 31.09210905600539)), ((16.706980757494215 27.88884595767101, -2.725595152038009 27.88884595767101, -2.7255951520380113 43.492109648140286, 19.560036470647162 43.492108991169516, 30.82140179267344 52.72291785038479, 37.31413428012374 44.80194000385802, 16.706980757494215 27.88884595767101)))')

    new_closures = closure.difference(removing_part)
    assert len(new_closures) == 1

    new_closure = new_closures[0]
    assert new_closure.shape.almost_equals(loads(
        'POLYGON ((-56.8255951128214 43.94210955600539, -18.92559515203799 43.94210955600539, -18.92559515203797 100.39210905365088, -48.26184825220687 100.39210905365088, -56.82559511282142 89.52158167573472, -56.82559511282142 72.67481803511708, -64.87559511282142 72.67481803511708, -64.8755951128214 50.20281793866988, -56.825595112821404 50.20281793866988, -56.8255951128214 43.94210955600539))'))
    assert len(new_closure.pivots) == 9
    assert len(new_closure.edges) == 9
