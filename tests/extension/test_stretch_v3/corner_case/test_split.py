import pytest

from shapely.extension.model.stretch.stretch_v3 import Stretch
from shapely.wkt import loads


@pytest.fixture
def stretch() -> Stretch:
    json_str = '{"pivot": {"0": [198.94880364903648, -43.205590197861916], "1": [196.86548450431775, -37.77788406986883], "2": [198.95140896572138, -37.77788406986883], "3": [198.95140896572138, 20.903957797711342], "4": [122.75137806015061, 20.903957797711342], "5": [122.75137806015061, 59.61924704999515], "6": [88.58193615218005, 69.58029003574609], "7": [70.1395328902342, 70.55395780186495], "8": [-97.24859261027132, 70.55395711919181], "9": [-181.41369182587104, 67.903950062969], "10": [-206.74859359656992, 60.74827907859783], "11": [-206.74859266392338, 51.00046268434173], "12": [-198.6985926639234, 51.00046345454521], "13": [-198.69859301377306, 54.65701639439406], "14": [-195.9365333860862, 55.437141382185935], "15": [-196.87427624899314, 58.75725257355698], "16": [-180.70567984945737, 63.32396284393671], "17": [-160.75185815641058, 63.95222525648472], "18": [-160.64328588542975, 60.50393407649797], "19": [-97.12189356673, 62.50395711970841], "20": [69.9271806649952, 62.50395780099879], "21": [87.22525281714282, 61.59070506320086], "22": [118.15137806015062, 52.57515064595245], "23": [118.15137806015062, 36.339958898731055], "24": [114.70137806015062, 36.339958898731055], "25": [114.70137806015062, 12.853957797711342], "26": [190.90140896572137, 12.853957797711338], "27": [190.90140896572137, -37.671805252699585], "28": [190.69605324584532, -37.7506270408743], "29": [193.58069556177898, -45.266033796940526], "30": [-214.0534798549007, 37.15322502172427], "31": [-206.74873163480848, 37.154005835362796], "32": [-206.74959210933338, 45.2040057893742], "33": [-217.28569200346953, 45.20287957252916], "34": [-235.14859561942822, 28.103957848986127], "35": [-235.14859253839165, -4.096042406857038], "36": [-225.4247969677064, -33.39604123342747], "37": [-209.5252148473475, -53.74258001327212], "38": [-169.63605071658026, -66.24604269114805], "39": [-147.28661973521434, -66.24604055299395], "40": [-120.73683599393834, -39.69626188496757], "41": [-114.24858830112599, -28.07889647763149], "42": [-114.24859485690388, 16.953957975117405], "43": [23.851374294463437, 17.055199587461942], "44": [23.851374294463426, -29.54940223209325], "45": [48.86703103505623, -49.896042202258684], "46": [110.17989051976082, -49.896042202243905], "47": [111.1642512145192, -52.46061354446711], "48": [118.67965797061336, -49.57597122860645], "49": [115.71267546498024, -41.84604220224258], "50": [51.72744485162612, -41.84604220225795], "51": [31.901374294463427, -25.72038442589826], "52": [31.901374294463427, 25.11110323626781], "53": [-122.29859602794536, 24.998058651858955], "54": [-122.29858860619933, -25.983291769147094], "55": [-127.21975701439784, -34.79476357723085], "56": [-150.6210387807825, -58.19604087199539], "57": [-168.40395000269484, -58.19604257327383], "58": [-192.18510764506738, -50.741716981354564], "59": [-193.2170205469389, -54.03377648308765], "60": [-206.78257316067373, -49.781584578231346], "61": [-216.43930580550213, -37.42395883969574], "62": [-213.72087120107545, -35.29966759284297], "63": [-218.22356659275957, -29.537612608662315], "64": [-227.09859266286676, -2.795148562639799], "65": [-227.09859529047299, 24.666038587590954], "66": [116.71957145785933, -66.93398206558612], "67": [121.6242213188176, -64.36362481329365], "68": [124.47503387072868, -71.79089432017207], "69": [155.23685407285973, -59.9835695607411], "70": [157.24356177071303, -65.21167860828763], "71": [164.43221176292212, -62.45245550372266], "72": [167.1556007815921, -69.54774635419835], "73": [192.08247779650395, -59.98005074257287], "74": [189.35908877743213, -52.88475989224713], "75": [195.05399332806633, -50.69888184401236], "76": [193.04728563015442, -45.47077279649784]}, "pivot_cargo": {"0": {}, "1": {}, "2": {}, "3": {}, "4": {}, "5": {}, "6": {}, "7": {}, "8": {}, "9": {}, "10": {}, "11": {}, "12": {}, "13": {}, "14": {}, "15": {}, "16": {}, "17": {}, "18": {}, "19": {}, "20": {}, "21": {}, "22": {}, "23": {}, "24": {}, "25": {}, "26": {}, "27": {}, "28": {}, "29": {}, "30": {}, "31": {}, "32": {}, "33": {}, "34": {}, "35": {}, "36": {}, "37": {}, "38": {}, "39": {}, "40": {}, "41": {}, "42": {}, "43": {}, "44": {}, "45": {}, "46": {}, "47": {}, "48": {}, "49": {}, "50": {}, "51": {}, "52": {}, "53": {}, "54": {}, "55": {}, "56": {}, "57": {}, "58": {}, "59": {}, "60": {}, "61": {}, "62": {}, "63": {}, "64": {}, "65": {}, "66": {}, "67": {}, "68": {}, "69": {}, "70": {}, "71": {}, "72": {}, "73": {}, "74": {}, "75": {}, "76": {}}, "edge_cargo": {"(0,1)": {"width": 0, "is_fixed": true, "is_starting": false}, "(1,2)": {"width": 0, "is_fixed": true, "is_starting": false}, "(2,3)": {"width": 0, "is_fixed": true, "is_starting": false}, "(3,4)": {"width": 0, "is_fixed": true, "is_starting": false}, "(4,5)": {"width": 0, "is_fixed": true, "is_starting": false}, "(5,6)": {"width": 0, "is_fixed": true, "is_starting": false}, "(6,7)": {"width": 0, "is_fixed": true, "is_starting": false}, "(7,8)": {"width": 0, "is_fixed": true, "is_starting": false}, "(8,9)": {"width": 0, "is_fixed": true, "is_starting": false}, "(9,10)": {"width": 0, "is_fixed": true, "is_starting": false}, "(10,11)": {"width": 0, "is_fixed": true, "is_starting": false}, "(11,12)": {"width": 0, "is_fixed": true, "is_starting": false}, "(12,13)": {"width": 0, "is_fixed": true, "is_starting": false}, "(13,14)": {"width": 0, "is_fixed": true, "is_starting": false}, "(14,15)": {"width": 0, "is_fixed": true, "is_starting": false}, "(15,16)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(16,17)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(17,18)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(18,19)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(19,20)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(20,21)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(21,22)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(22,23)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(23,24)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(24,25)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(25,26)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(26,27)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(27,28)": {"width": 0, "is_fixed": true, "is_starting": false}, "(28,29)": {"width": 0, "is_fixed": true, "is_starting": false}, "(29,0)": {"width": 0, "is_fixed": true, "is_starting": false}, "(30,31)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(31,32)": {"width": 0, "is_fixed": true, "is_starting": false}, "(32,33)": {"width": 0, "is_fixed": true, "is_starting": false}, "(33,34)": {"width": 0, "is_fixed": true, "is_starting": false}, "(34,35)": {"width": 0, "is_fixed": true, "is_starting": false}, "(35,36)": {"width": 0, "is_fixed": true, "is_starting": false}, "(36,37)": {"width": 0, "is_fixed": true, "is_starting": false}, "(37,38)": {"width": 0, "is_fixed": true, "is_starting": false}, "(38,39)": {"width": 0, "is_fixed": true, "is_starting": false}, "(39,40)": {"width": 0, "is_fixed": true, "is_starting": false}, "(40,41)": {"width": 0, "is_fixed": true, "is_starting": false}, "(41,42)": {"width": 0, "is_fixed": true, "is_starting": false}, "(42,43)": {"width": 0, "is_fixed": true, "is_starting": false}, "(43,44)": {"width": 0, "is_fixed": true, "is_starting": false}, "(44,45)": {"width": 0, "is_fixed": true, "is_starting": false}, "(45,46)": {"width": 0, "is_fixed": true, "is_starting": false}, "(46,47)": {"width": 0, "is_fixed": true, "is_starting": false}, "(47,48)": {"width": 0, "is_fixed": true, "is_starting": false}, "(48,49)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(49,50)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(50,51)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(51,52)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(52,53)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(53,54)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(54,55)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(55,56)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(56,57)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(57,58)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(58,59)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(59,60)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(60,61)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(61,62)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(62,63)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(63,64)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(64,65)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(65,30)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(31,30)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(30,65)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(65,64)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(64,63)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(63,62)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(62,61)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(61,60)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(60,59)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(59,58)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(58,57)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(57,56)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(56,55)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(55,54)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(54,53)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(53,52)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(52,51)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(51,50)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(50,49)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(49,48)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(48,47)": {"width": 0, "is_fixed": true, "is_starting": false}, "(47,66)": {"width": 0, "is_fixed": true, "is_starting": false}, "(66,67)": {"width": 0, "is_fixed": true, "is_starting": false}, "(67,68)": {"width": 0, "is_fixed": true, "is_starting": false}, "(68,69)": {"width": 0, "is_fixed": true, "is_starting": false}, "(69,70)": {"width": 0, "is_fixed": true, "is_starting": false}, "(70,71)": {"width": 0, "is_fixed": true, "is_starting": false}, "(71,72)": {"width": 0, "is_fixed": true, "is_starting": false}, "(72,73)": {"width": 0, "is_fixed": true, "is_starting": false}, "(73,74)": {"width": 0, "is_fixed": true, "is_starting": false}, "(74,75)": {"width": 0, "is_fixed": true, "is_starting": false}, "(75,76)": {"width": 0, "is_fixed": true, "is_starting": false}, "(76,29)": {"width": 0, "is_fixed": true, "is_starting": false}, "(29,28)": {"width": 0, "is_fixed": true, "is_starting": false}, "(28,27)": {"width": 0, "is_fixed": true, "is_starting": false}, "(27,26)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(26,25)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(25,24)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(24,23)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(23,22)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(22,21)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(21,20)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(20,19)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(19,18)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(18,17)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(17,16)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(16,15)": {"width": 2.75, "is_fixed": true, "is_starting": false}, "(15,14)": {"width": 0, "is_fixed": true, "is_starting": false}, "(14,13)": {"width": 0, "is_fixed": true, "is_starting": false}, "(13,12)": {"width": 0, "is_fixed": true, "is_starting": false}, "(12,11)": {"width": 0, "is_fixed": true, "is_starting": false}, "(11,32)": {"width": 0, "is_fixed": true, "is_starting": false}, "(32,31)": {"width": 0, "is_fixed": true, "is_starting": false}}, "closure": {"0": {"exterior": ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "0"], "interiors": []}, "1": {"exterior": ["30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59", "60", "61", "62", "63", "64", "65", "30"], "interiors": []}, "2": {"exterior": ["11", "32", "31", "30", "65", "64", "63", "62", "61", "60", "59", "58", "57", "56", "55", "54", "53", "52", "51", "50", "49", "48", "47", "66", "67", "68", "69", "70", "71", "72", "73", "74", "75", "76", "29", "28", "27", "26", "25", "24", "23", "22", "21", "20", "19", "18", "17", "16", "15", "14", "13", "12", "11"], "interiors": []}}, "closure_cargo": {"0": {"angle": 0, "region_type": "surrounding", "clamp": false}, "1": {"angle": 0, "region_type": "surrounding", "clamp": false}, "2": {"angle": 0, "region_type": "core", "clamp": false}}}'
    return Stretch.loads(json_str)


def test_split(stretch):
    dividing_lines = loads(
        'MULTILINESTRING ((-226.83179821988708 24.92142496396614, -206.74959210933338 24.936147305605047), (-206.74959210933338 24.936147305605047, -179.59500767884788 24.956054434674805), (-179.59500767884788 24.956054434674805, -118.68625408439192 25.00070687346969), (-118.68625408439192 25.00070687346969, -92.03325513318362 25.02024628831789), (-92.03325513318362 25.02024628831789, -9.247115088551368 25.080937122282748), (-9.247115088551368 25.080937122282748, 114.70137806015062 25.17180423378024), (-160.70625824840062 62.50395711970841, -183.6089386102226 62.50395711970841), (96.87193906218116 58.77851232631966, 31.901374294463427 58.77851232631966), (31.901374294463427 58.77851232631966, -9.247115088551368 58.77851232631966), (-9.247115088551368 58.77851232631966, -9.248115088551367 58.77851232631966), (-122.29859029557925 -14.37862773281745, -179.59500767884788 -14.37862773281745), (-179.59500767884788 -14.37862773281745, -223.25438146972652 -14.37862773281745), (190.71185804723146 -37.79180355362928, 46.74286545535957 -37.79180355362928), (-118.68625408439192 25.00070687346969, -118.68625944518446 61.82498540490811), (-206.74959210933338 37.1540057433856, -206.74959210933338 24.936147305605047), (-92.03325513318362 62.503957140461836, -92.03325513318362 25.02024628831789), (-9.247115088551368 25.080937122282748, -9.247115088551368 58.77851232631966), (-9.247115088551368 58.77851232631966, -9.247115088551368 62.50395747809556), (31.901374294463427 62.50395764591492, 31.901374294463427 58.77851232631966), (31.901374294463427 58.77851232631966, 31.901374294463427 25.111103236268775), (-179.59500767884788 -54.68814826087275, -179.59500767884788 -14.37862773281745), (-179.59500767884788 -14.37862773281745, -179.59500767884788 24.956054434674805))')

    assert len(stretch.closures) == 3
    stretch.split(dividing_lines)
    assert len(stretch.closures) == 17
    assert len([edge for edge in stretch.edges if not edge.closure]) == 0
    assert len([pivot for pivot in stretch.pivots if pivot.dangling]) == 0
