import random
from typing import List

from shapely.extension.geometry.straight_segment import StraightSegment
from shapely.extension.model.envelope import Envelope
from shapely.extension.model.vector import Vector
from shapely.extension.strategy.simplify_strategy import BufferSimplifyStrategy
from shapely.extension.util.insertion.rect_insertion import RectInsertion
from shapely.geometry import Polygon, box, LineString, Point
from shapely.ops import unary_union
from shapely.wkt import loads


class TestInsertion:
    def test_bounce_seg(self):
        insertion = RectInsertion(inserter=Envelope(geom_or_geoms=box(0, 0, 1, 1), angle=0))

        bounce_seg = insertion._bounce_segment(convex_ccw_segment=StraightSegment([(0, 0), (1, 0)]))
        assert bounce_seg.equals(LineString([(-0.5, -0.5), (1.5, -0.5)]))

        bounce_seg = insertion._bounce_segment(convex_ccw_segment=StraightSegment([(0, 0), (-1, 0)]))
        assert bounce_seg.equals(LineString([(0.5, 0.5), (-1.5, 0.5)]))

        bounce_seg = insertion._bounce_segment(convex_ccw_segment=StraightSegment([(0, 0), (0, 1)]))
        assert bounce_seg.equals(LineString([(0.5, -0.5), (0.5, 1.5)]))

        bounce_seg = insertion._bounce_segment(convex_ccw_segment=StraightSegment([(0, 0), (0, -1)]))
        assert bounce_seg.equals(LineString([(-0.5, 0.5), (-0.5, -1.5)]))

        #
        bounce_seg = insertion._bounce_segment(convex_ccw_segment=StraightSegment([(0, 0), (1, 1)]))
        assert bounce_seg.equals(LineString([(0.5, -0.5), (1.5, 0.5)]))

        bounce_seg = insertion._bounce_segment(convex_ccw_segment=StraightSegment([(1, 1), (0, 0)]))
        assert bounce_seg.equals(LineString([(0.5, 1.5), (-0.5, 0.5)]))

        bounce_seg = insertion._bounce_segment(convex_ccw_segment=StraightSegment([(1, 0), (0, 1)]))
        assert bounce_seg.equals(LineString([(1.5, 0.5), (0.5, 1.5)]))

        bounce_seg = insertion._bounce_segment(convex_ccw_segment=StraightSegment([(0, 1), (1, 0)]))
        assert bounce_seg.equals(LineString([(-0.5, 0.5), (0.5, -0.5)]))

    def test_insertion(self):
        def do_assertion(insertions):
            assert isinstance(insertions, List)
            assert len(insertions) == 1
            assert insertions[0].ext.similar(Polygon([(1, 1), (9, 1), (9, 10), (5, 14), (1, 10)]),
                                             area_diff_tol=1e-10)

        inserter = Envelope(geom_or_geoms=Polygon([(0, 0), (1, 1), (0, 2), (-1, 1)]), angle=45)
        insertion = RectInsertion(inserter=inserter)

        space = Polygon([(0, 0), (10, 0), (10, 10), (5, 15), (0, 10), (0, 0)])

        valid_insertion = insertion.of(space=space)
        do_assertion(valid_insertion)

        space = box(0, 0, 10, 15)

        valid_insertion = insertion.of(space=space, obstacle=unary_union([Polygon([(0, 10), (5, 15), (0, 15)]),
                                                                          Polygon([(10, 10), (5, 15), (10, 15)])]))
        do_assertion(valid_insertion)

        space = box(0, 0, 10, 10.5).union(box(-0.5, 10, 10.5, 15.5)).difference(
            unary_union([Polygon([(0, 10), (5, 15), (0, 15)]),
                         Polygon([(10, 10), (5, 15), (10, 15)])])).union(box(-0.5, 10, 10.5, 10.5))

        valid_insertion = insertion.of(space=space)
        do_assertion(valid_insertion)

    def test_real_insertion(self):
        obstacle = loads(
            'MULTIPOLYGON (((34.362333286818625 -1.4120922072689837, 35.462333286818634 -1.4120922072689837, 35.462333286818634 -1.9120922072689837, 34.362333286818625 -1.9120922072689837, 34.362333286818625 -2.5120922072688927, 33.362333286818625 -2.5120922072688927, 33.362333286818625 1.6379077987317032, 33.212333287318614 1.6379077987317032, 33.212333287318614 1.8879077987317032, 33.862333286818625 1.8879077987317032, 33.862333286818625 -1.4120922072689837, 34.362333286818625 -1.4120922072689837)), ((38.01233328681863 -1.9120922072689837, 38.01233328681863 -1.4120922072689837, 39.112333286818625 -1.4120922072689837, 39.112333286818625 1.6379077937308466, 39.612333286818625 1.6379077937308466, 39.612333286818625 -0.9120922072689837, 40.112333286818625 -0.9120922072689837, 40.112333286818625 -1.9120922072689837, 39.112333286818625 -1.9120922072689837, 38.01233328681863 -1.9120922072689837)), ((32.06233328681844 3.637907798731817, 35.01233328681843 3.637907798731021, 35.01233328681863 3.1379077838023477, 35.66233328681864 3.137907785730931, 35.66233328681864 2.7379077857308403, 34.712333286818634 2.73790778344528, 34.712333286818634 3.337907798730953, 32.31233328681866 3.3379077987317487, 32.31233328681866 1.8879077987317032, 32.512333287318654 1.8879077987317032, 32.512333287318654 1.6379077987317032, 32.06233328681866 1.6379077987317032, 32.06233328681844 3.637907798731817)), ((39.56233328681863 2.7379077930642097, 39.212333286818634 2.7379077930642097, 39.212333286818634 2.7379078342574985, 39.11233328703884 2.737907834257612, 39.11233328703773 5.287907794312332, 39.00212617185103 5.287907793731051, 38.56233328681863 5.287907793731051, 38.56233328681863 5.587907793731233, 39.612333286818625 5.587907793731233, 39.612333286818526 2.7379078342574985, 39.56233328681863 2.7379078342574985, 39.56233328681863 2.7379077930642097)), ((35.41233328681864 5.337907793730778, 35.41233328681864 5.837907793730665, 35.912333287025916 5.837907793730665, 35.912333287025916 6.187907794293437, 36.112333286818625 6.187907794293437, 36.112333286818625 5.337907793730778, 35.41233328681864 5.337907793730778)), ((30.062333290919284 5.937907799127856, 30.062333290919284 8.337907799127947, 29.4623332779193 8.337907799127947, 29.462333277919228 9.28790779912788, 29.86233327791919 9.28790779912788, 29.86233327791932 8.637907799128016, 30.362333290919295 8.637907799128016, 30.362333290919295 5.687907799127856, 28.362333290919267 5.687907799127856, 28.362333290919267 6.137907799627897, 28.612333290919295 6.137907799627897, 28.612333290919295 5.937907799127856, 30.062333290919284 5.937907799127856)), ((28.612333290919295 7.4879077991275835, 28.612333290919295 6.837907799627715, 28.362333290919267 6.837907799627715, 28.362333290919267 6.987907799127811, 24.212333338919322 6.987907799126788, 24.212333338919322 7.587907798996071, 24.812333232566047 7.587907798996071, 24.812333232566047 9.087907799127038, 25.212333338919336 9.087907799127038, 25.212333338919336 7.987907799127015, 25.212333338919336 7.487907799126901, 28.612333290919295 7.4879077991275835)), ((32.06233328591928 9.737907799127811, 32.91233328650932 9.737907799127811, 32.91233328650932 9.537907799530899, 32.56233328591922 9.537907799530899, 32.56233328591922 9.03790779912788, 32.06233328591928 9.03790779912788, 32.06233328591928 9.737907799127811)), ((36.765187720578425 10.36355423730015, 37.383906154406034 9.744835803472597, 37.101063494478424 9.461993143544873, 36.48234506065083 10.08071157737254, 36.765187720578425 10.36355423730015)), ((35.121164508710535 10.02767857070694, 34.90903247435452 10.239810605062871, 35.89898196807742 11.229760099185228, 36.34092370639243 10.787818360864208, 36.05808099384602 10.504975648559594, 35.82827129016172 10.734785352235917, 35.121164508710535 10.02767857070694)), ((36.21619277946313 12.878306242913368, 39.34160475215673 9.752894270240631, 39.34160475215673 9.752894270240176, 39.214325519811524 9.62561503790937, 36.08891354711632 12.751027010580628, 36.21619277946313 12.878306242913368)), ((26.212333233919196 12.137907940127093, 24.812333232566047 12.137907940127093, 24.812333232566047 12.837907939996057, 24.812333232566004 13.137907940127207, 28.362333285919277 13.137907940127207, 28.362333285919277 12.637907940128002, 26.212333233919196 12.63790794012732, 26.212333233919196 12.137907940127093)), ((32.06233328474208 11.825127212871053, 32.06233328503052 12.637907799695881, 29.4623332779193 12.637907799543768, 29.4623332779193 13.137907940298192, 32.31233328591928 13.137907939957358, 32.31233328591928 13.13790793489352, 34.062333319554725 13.13790793489352, 34.06233318389182 14.737907794110015, 34.56233322362263 14.737907794076591, 34.56233317838132 12.566408885032843, 35.02077215244182 12.107969914910655, 34.737929440126734 11.825127202507815, 32.31233329102304 11.825127212715302, 32.31233328591928 12.481518509559919, 32.31233328591928 11.825127212715302, 32.06233328474208 11.825127212871053)), ((29.46233328665332 19.837907794127318, 29.46233328591927 20.287907794127705, 32.46233328591927 20.287907794127705, 32.46233328591927 20.78790779912765, 32.762333286360416 20.78790779912765, 32.762333286621214 20.28782408530617, 32.762333286621214 20.787907795335173, 34.712333286818634 20.78790779414544, 34.712333286818634 20.287907794144417, 39.16233328703352 20.287907794144417, 39.16233328703352 19.787907794144758, 34.56233328681732 19.787907794145667, 34.56233328682163 18.187907794251146, 34.06233328682163 18.187907794251146, 34.06233328681843 19.787907794145667, 32.762333286881926 19.787907795335514, 32.762333286881926 19.787907791542807, 29.46233328717473 19.78790779665735, 29.46233328665332 19.83790779412743, 29.46233328665332 19.837907794127318)), ((26.21233323391924 20.78790779412725, 26.21233323391924 20.287907794127705, 28.362333285919277 20.287907794127705, 28.362333285919277 19.78790779412782, 23.31233321756605 19.787907794127022, 23.31233321756605 20.78790779412725, 23.7123331839193 20.78790779412725, 23.7123331839193 20.287907794127136, 24.712333233919196 20.287907794127136, 24.71233323391924 20.78790779412725, 26.21233323391924 20.78790779412725)), ((32.21233328591927 23.53790779912788, 32.21233328591927 22.03790779912788, 32.762333285919226 22.03790779912788, 32.762333285919226 21.637907799127902, 31.912333285919274 21.637907799127902, 31.912333285919274 22.03790779912788, 31.912333285919274 23.53790779912788, 31.912333285919274 23.837907799127834, 30.412333285919274 23.837907799127834, 30.412333285919274 24.23790779912781, 31.912333285919274 24.23790779912781, 32.412333285919274 24.23790779912781, 32.412333285919274 23.737907799429763, 32.762333286089515 23.737907799429763, 32.762333286089515 23.53790779912788, 32.21233328591927 23.53790779912788)), ((27.112333285919277 23.837907799127834, 27.112333285919277 24.337907799127038, 23.7123331839193 24.337907799127038, 23.7123331839193 23.83790779912681, 23.7123331839193 22.737907799127015, 23.31233321756605 22.737907799127015, 23.31233321756605 24.237907798996048, 22.71233318391927 24.237907798996048, 22.71233318391927 24.83790779899607, 27.412333285919274 24.83790779899607, 27.412333285919274 23.837907799127834, 27.112333285919277 23.837907799127834)), ((46.01233328720363 -1.5620922057132702, 46.06233326690263 -1.5620922057132702, 46.06233326690263 -1.912092206325383, 46.01233328720363 -1.912092206325383, 46.01233328720363 -1.5620922057132702)), ((50.212333286818634 -3.012092247269038, 50.712333286818634 -3.012092247269038, 50.712333286818634 0.3879077937308466, 50.212333286818634 0.3879077937308466, 50.212333286818634 0.6879077937308011, 51.21233328546542 0.6879077937308011, 51.21233328546542 -4.012092247269038, 50.612333285465425 -4.012092247269038, 50.612333285465425 -3.412092203400107, 49.112333286818625 -3.412092203400107, 49.112333286818625 -3.012092247269038, 50.212333286818634 -3.012092247269038)), ((47.06233328681863 -3.412092203400107, 46.06233328681863 -3.412092203400107, 46.06233328681863 1.6379077937308466, 46.56233328681863 1.6379077937308466, 46.56233328681863 -2.512092247269038, 47.06233328681863 -2.512092247269038, 47.06233328681863 -3.412092203400107)), ((42.66233328676452 -1.562092207296132, 42.66233328681864 2.737907793730983, 43.01233328681863 2.737907793730983, 43.01233328676463 -1.562092207296132, 43.61233328476463 -1.562092207296132, 43.61233328481863 -1.9120922072689837, 42.06233329150403 -1.9120922072689837, 42.06233329144992 -1.562092207296132, 42.66233328676452 -1.562092207296132)), ((46.56233328681863 2.737907793730983, 46.112333286818625 2.737907793730983, 46.112333286818625 2.737907834745556, 46.062333286692834 2.7379078347389623, 46.062333286692834 6.037907794269131, 47.16233328700012 6.037907794269131, 47.16233327804443 5.7379078167308535, 46.56233328681863 5.7379078167308535, 46.56233328681863 2.737907793730983)), ((50.612333286818625 5.687907793730801, 50.612333286818625 5.187907793730574, 50.612333286818625 3.6879078847309756, 50.212333286818634 3.6879078847309756, 50.212333286818634 5.187907793730574, 49.91233328681864 5.187907793730574, 49.91233328681864 5.187907884730976, 48.41233328681864 5.187907884730976, 48.01233328681863 5.187907884730976, 48.01233328681863 6.037907884730998, 48.41233328681864 6.037907884730998, 48.41233328681864 5.48790788473093, 49.91233328681864 5.48790788473093, 49.91233328681864 6.037907794129637, 50.112333287155025 6.037907794129637, 50.112333287155025 5.687907793730801, 50.612333286818625 5.687907793730801)), ((42.66233328661103 7.387907791614111, 42.26233328649103 7.387907791614111, 42.26233328649103 7.887907791614111, 43.41233328676283 7.887907793741988, 43.41233328676283 7.387907793741988, 43.01233328661104 7.387907791614111, 43.01233328661104 7.072618169033149, 43.01233328681863 4.637907794731063, 42.66233328681864 4.637907794731063, 42.66233328661103 7.072618169033149, 42.66233328661103 7.387907791614111)), ((37.80817027790623 9.320571789640667, 38.68908372872153 8.439658338393542, 39.24254292313603 7.8879077917915765, 41.11233328732523 7.88790779342969, 41.11233328697122 7.387907791339899, 41.031968621089135 7.387907791616158, 38.34811962162762 7.387907791611838, 38.348119620964326 8.214937021644005, 38.05565765111582 8.50739899149255, 37.34855086703942 7.800292207415964, 37.136418832744226 8.012424241711415, 37.84352561682063 8.71953102578766, 37.525327565375434 9.037729077232825, 37.80817027790623 9.320571789640667)), ((44.712333286654726 7.887907794838952, 44.712333286039126 12.287907794173861, 45.212333285948915 12.287907794354282, 45.21233328740452 7.887907794673083, 46.51233328696583 7.88790779432054, 46.51233328696583 7.387907794320313, 44.56233328669403 7.387907795371007, 44.56233328724963 7.88790779509327, 44.712333286654726 7.887907794838952)), ((48.56233328518333 8.487907691966825, 48.56233328518333 8.987907691966825, 50.16233328518334 8.987907691966825, 50.16233328518334 9.937907793752856, 50.762333285236025 9.937907793752856, 50.762333285236025 15.887907793752788, 50.26233328550204 15.887907793752788, 50.26233328550204 17.087907793752606, 51.26233328552203 17.087907793752606, 51.26233328537762 8.487907794522698, 51.21233328546542 8.487907794522698, 51.21233328546542 8.487907691966825, 50.16233328518334 8.487907691966825, 48.56233328518333 8.487907691966825)), ((57.36233328550243 9.737907793752584, 57.86233328533662 9.737907793752584, 57.86233328533662 15.887907793752788, 57.36233328550203 15.887907793752788, 57.36233328550203 17.087907793752606, 58.36233328562203 17.087907793752606, 58.36233328548232 8.487907794522698, 55.76233328550242 8.487907794522698, 55.76233328550242 8.987907691966825, 57.36233328550243 8.987907691966825, 57.36233328550243 9.737907793752584)), ((43.20947884489193 11.202463171535555, 42.74985943725933 11.662082578665945, 42.891280793496634 11.803503934902892, 43.412333286949035 11.282451442748538, 43.412333286950116 11.12247490111929, 41.54777790940993 9.257919523579062, 35.89092366019953 14.91477377172555, 37.76405767925273 16.78790779389533, 37.90687693582343 16.78790779389533, 38.43650807149662 16.258276656902922, 38.29508671525933 16.11685530066552, 37.835467307188125 16.57647470923962, 36.17376637255653 14.914773771842874, 39.709300278358725 11.379239867002411, 41.37100121414062 13.040940802784348, 40.91138180625933 13.50056021066564, 41.05280316249663 13.641981566903041, 42.11346333449663 12.581321394903057, 41.97204197825933 12.439900038665769, 41.512422570378035 12.89951944654706, 39.85072163446374 11.237818510632792, 41.547777909346024 9.540762235989632, 43.20947884489193 11.202463171535555)), ((45.962333285183234 14.187907793752856, 46.46233329350201 14.187907793752856, 46.46233329350201 15.987907793571708, 46.36233329350202 15.987907793571708, 46.36233329350202 16.48790779375213, 46.96233329350201 16.48790779375213, 46.962333285183234 14.187907793752856, 46.962333285183234 13.187907793752743, 45.962333285183234 13.187907793752743, 45.962333285183234 13.58790779395838, 44.783832198586936 13.587907793258637, 43.606576096953134 14.765163894477723, 43.96012948754172 15.118717285129605, 44.99951762198903 14.087907794455987, 45.962333285183234 14.08790779325841, 45.962333285183234 14.187907793752856)), ((40.96233343999383 20.987907793645718, 40.962333388818024 18.125092027714913, 41.58313294516722 17.495713827502755, 41.22957955465071 17.1421604369865, 40.462333388818024 17.909406602761692, 40.46233333807622 20.987907793645718, 40.06233338871132 20.987907793645718, 40.06233338871132 21.987907793645718, 41.06233338871132 21.987907793645718, 43.362333388711335 21.987907793645945, 43.362333388711335 21.38790779364581, 42.862333388711335 21.38790779364581, 42.862333388711335 21.48790779364583, 41.06233338871132 21.48790779364583, 41.06233338871132 20.987907793645718, 40.96233343999383 20.987907793645718)), ((35.36233328692522 25.18790779364599, 35.36233328692522 26.287907793864292, 36.812333388572625 26.287907793864292, 42.762333388711326 26.287907793964564, 43.96233338871133 26.287907793964564, 43.96233338871133 25.287907793964564, 42.762333388711326 25.287907793964564, 42.762333388711326 25.787907793698537, 36.81233338871132 25.787907793698537, 36.81233338871132 25.18790779364599, 35.86233328692522 25.18790779364599, 35.86233328692522 23.587907793645854, 35.36233328692522 23.587907793645854, 35.36233328692522 25.18790779364599)), ((35.36233328692522 30.787907793964905, 35.36233328692522 32.38790779396493, 35.36233328692522 33.38790779396493, 36.612333388585924 33.38790779396493, 42.762333388711326 33.3879077940652, 43.96233338871133 33.38790779396459, 43.96233338871133 32.38790779396459, 42.762333388711326 32.38790779396459, 42.762333388711326 32.88790779379917, 36.612333388711335 32.88790779379917, 36.612333388711335 32.38790779396493, 35.86233328692522 32.38790779396493, 35.86233328692522 30.787907793964905, 35.36233328692522 30.787907793964905)))')
        obstacle = unary_union(obstacle.ext.simplify(BufferSimplifyStrategy().mitre(0.1)))

        inserter = Envelope(geom_or_geoms=box(0, 0, 2, 4), angle=0)
        insertion = RectInsertion(inserter=inserter)

        space = box(20, -10, 70, 40)

        valid_insertions = insertion.of(space=space, obstacle=obstacle)
        assert isinstance(valid_insertions, List)
        valid_insertion = unary_union(valid_insertions)
        expected = loads(
            'MULTIPOLYGON (((40.61233328681863 3.384336367787049, 40.61233328681864 3.587907793731233, 40.61233328681864 5.3879077916138725, 41.26233328649102 5.387907791614919, 41.26233328649102 5.387907791614111, 41.66233328661102 5.387907791614111, 41.66233328661102 5.072618169033148, 41.6623332867956 2.90798507429124, 41.662333286764515 0.4379077927038679, 41.11233328681863 0.4379077927038679, 41.11233328681863 1.0879077927310161, 41.11233328681863 1.0879077927310163, 40.61233328681863 1.0879077927310163, 40.61233328681863 3.384336367787049)), ((33.909032474354504 9.82512720250781, 33.909032474354504 8.239810605062875, 34.12116450871053 8.027678570706943, 35.535378067316415 8.027678570706943, 35.72514884429267 7.837907793730665, 34.41233328681863 7.837907793730665, 34.41233328681863 5.637907798731453, 33.06233328681844 5.637907798731816, 31.36233329091929 5.637907798731816, 31.36233329091929 6.637907799128017, 31.36233329091929 7.037907799127877, 33.56233328591923 7.037907799127877, 33.56233328591923 9.82512720324676, 33.73792944012673 9.82512720250781, 33.909032474354504 9.82512720250781)), ((41.512422569748416 9.89951944591744, 41.52403422224885 9.88790779342969, 41.500810917260665 9.88790779342969, 41.512422569748416 9.89951944591744)), ((28.462333277919235 10.637907940127715, 28.462333277919235 9.487907799127584, 27.61233329091929 9.487907799127584, 26.21233333891933 9.487907799127303, 26.21233333891933 10.137907940127091, 27.21233323391919 10.137907940127091, 27.21233323391919 10.637907940127318, 28.462333277919235 10.637907940127715)), ((30.862333277919316 10.637907799128017, 30.862333277919316 10.63790779956717, 31.062333284742067 10.637907799578871, 31.062333284742067 10.637907799128017, 30.862333277919316 10.637907799128017)), ((20.999999999999996 -7.999999999999998, 20.999999999999996 37.99999999999999, 69.00000000000001 37.99999999999999, 69.00000000000001 -7.999999999999998, 20.999999999999996 -7.999999999999998), (32.36233328681862 -0.3620922012682968, 32.36233328681862 -0.5120922072688927, 32.36233328681862 -4.512092207268893, 34.36233328681862 -4.512092207268893, 35.36233328681863 -4.512092207268893, 35.36233328681863 -3.9120922072689837, 36.46233328681864 -3.9120922072689837, 36.46233328681864 0.5879077927310163, 34.86233328681863 0.5879077927310163, 34.86233328681863 0.7379077834452801, 35.71233328681863 0.7379077834452801, 36.662333286818644 0.7379077857308407, 36.662333286818644 3.3379077937307784, 37.112333286786736 3.3379077937307784, 37.1123332869462 3.8379077937306647, 37.1123332869462 5.8002922074159615, 37.34811962129688 5.8002922074159615, 37.34811962162762 5.387907791611838, 37.56233328681862 5.387907791611838, 37.56233328681862 3.2879077937310512, 38.11233328681862 3.2879077937310512, 38.11233328681862 0.5879077927310163, 37.012333286818624 0.5879077927310163, 37.012333286818624 -3.9120922072689837, 39.11233328681863 -3.9120922072689837, 41.062333291504025 -3.9120922072689837, 41.11233328681863 -3.9120922072689837, 43.062333291504025 -3.9120922072689837, 44.61233328481864 -3.9120922072689837, 44.61233328481864 0.0879077927310161, 44.61233328476464 0.4379077927038679, 44.012333286814865 0.4379077927038679, 44.01233328681863 0.737907793730983, 44.01233328681863 2.6379077947310634, 44.01233328681864 2.6379077947310634, 44.01233328681864 5.387907791614112, 44.41233328676284 5.387907793741989, 44.41233328676284 5.387907794913012, 45.06233328669283 5.38790779456278, 45.06233328669283 4.037907794269131, 45.06233328669283 0.7379078347389623, 45.06233328681862 0.7379078347389623, 45.06233328681862 -1.4120922034001069, 45.06233328681862 -5.412092203400107, 47.06233328681862 -5.412092203400107, 48.062333286818635 -5.412092203400107, 48.062333286818635 -0.5120922472690381, 47.562333286818635 -0.5120922472690381, 47.562333286818635 0.737907793730983, 47.562333286818635 3.187907858436649, 48.91333328686177 3.1879077937305738, 49.21233328681863 3.1879077937305738, 49.21233328681863 2.687907793730801, 49.21233328681863 1.6879078847309756, 49.21233328681863 -1.0120922472690381, 48.11233328681862 -1.0120922472690381, 48.11233328681862 -5.412092203400107, 49.61233328546542 -5.412092203400107, 49.61233328546542 -6.012092247269037, 50.21233328546543 -6.012092247269037, 52.21233328546543 -6.012092247269037, 52.21233328546543 -2.0120922472690372, 52.21233328546543 -1.3120922062691989, 52.21233328546543 2.687907793730801, 51.61233328681863 2.687907793730801, 51.61233328681863 3.687907793730801, 51.61233328681863 6.48790773591934, 52.262333285377615 6.487907799406306, 52.262333285522054 15.0879077937526, 52.262333285522054 19.0879077937526, 50.262333285522054 19.0879077937526, 49.26233328550203 19.0879077937526, 49.26233328550203 13.887907793752786, 49.76233328523602 13.887907793752786, 49.76233328523602 11.937907793752858, 49.16233328518333 11.937907793752858, 49.16233328518333 10.987907691966827, 47.56233328518332 10.987907691966827, 47.56233328518332 8.037907884730998, 47.512333286965834 8.037907884730998, 47.512333286965834 9.88790779432054, 46.21233328740453 9.887907794673083, 46.21233328697447 11.187907793752741, 47.96233328518324 11.187907793752741, 47.96233328518324 12.187907793752856, 47.96233329350202 14.487907793752122, 47.96233329350202 18.48790779375212, 45.96233329350202 18.48790779375212, 45.36233329350201 18.48790779375212, 45.36233329350201 16.719833089102714, 44.96012948754173 17.118717285129613, 42.96012948754173 17.118717285129613, 42.606576096953134 16.765163894477737, 42.606576096953134 15.088208632446515, 42.39110192353198 15.303682805867647, 42.58313294516722 15.495713827502748, 42.58313294516722 19.387907793645816, 44.36233338871134 19.387907793645816, 44.36233338871134 19.987907793645938, 44.36233338871134 23.28790779396457, 44.962333388711336 23.28790779396457, 44.962333388711336 28.287907793964557, 43.76233338871132 28.287907793964557, 41.76233338871132 28.287907793964557, 35.81233338856922 28.287907793864285, 34.362333286925214 28.287907793864285, 34.362333286925214 25.737907799429756, 33.41233328591928 25.737907799429756, 33.41233328591928 26.237907799127804, 31.41233328591928 26.237907799127804, 29.41233328591928 26.237907799127804, 29.41233328591928 22.287907794127698, 29.36233328591927 22.287907794127698, 28.462333285919282 22.287907794127698, 28.412333285919267 22.287907794127698, 28.412333285919267 22.837907798996063, 28.412333285919267 26.837907798996063, 26.412333285919267 26.837907798996063, 23.712333183919277 26.837907798996063, 21.712333183919277 26.837907798996063, 21.712333183919277 22.837907798996063, 21.712333183919277 22.237907798996055, 22.312333217566056 22.237907798996055, 22.312333217566056 21.787907794127026, 22.312333217566056 20.737907799127022, 22.312333217566056 17.787907794127026, 24.312333217566056 17.787907794127026, 29.36233328591927 17.78790779412783, 29.36233328591927 17.787907796296853, 31.762332664527655 17.787907795335524, 33.06233328681843 17.787907794145674, 33.062333286820525 16.737907794110015, 33.06233318389183 16.737907794110015, 33.06233318389183 15.137907939987258, 30.462333277919306 15.137907940298197, 28.462333277919306 15.137907940298197, 28.462333277919306 15.137907940127208, 23.81233323256601 15.137907940127208, 23.81233323256601 11.137907940127208, 23.812333232566054 10.837907939996029, 23.812333232566054 10.137907940127091, 23.812333232566054 9.58790779899607, 23.21233333891933 9.58790779899607, 23.21233333891933 8.987907799126788, 23.21233333891933 4.987907799126787, 25.21233333891933 4.987907799126787, 27.362333290919274 4.987907799127317, 27.362333290919274 4.837907799627715, 27.362333290919274 3.6879077991278564, 29.362333290919274 3.6879077991278564, 29.36233329091929 3.6879077991278564, 31.062333286818443 3.6879077991278564, 31.062333286818443 1.637907798731816, 31.062333286818657 -0.3620922012682968, 32.21233328731861 -0.3620922012682968, 32.36233328681862 -0.3620922012682968), (36.86233328692523 28.787907793964912, 36.86233328692523 30.38790779396492, 37.61233338871134 30.38790779396492, 37.61233338871134 30.887907793799165, 41.76233338871132 30.887907793799165, 41.76233338871132 30.38790779396458, 44.962333388711336 30.38790779396458, 44.962333388711336 31.387907793964594, 44.962333388711336 35.387907793964594, 43.76233338869437 35.38790779406521, 41.76233338869437 35.38790779406521, 35.61233338858263 35.387907793964935, 34.362333286925214 35.387907793964935, 34.362333286925214 31.387907793964935, 34.362333286925214 28.787907793964912, 36.86233328692523 28.787907793964912), (57.36233328548233 6.487907794522696, 59.36233328548233 6.487907794522696, 59.362333285622036 15.0879077937526, 59.362333285622036 19.0879077937526, 57.362333285622036 19.0879077937526, 56.362333285502025 19.0879077937526, 56.362333285502025 13.887907793752786, 56.86233328533661 13.887907793752786, 56.86233328533661 11.737907793752585, 56.36233328550242 11.737907793752585, 56.36233328550242 10.987907691966827, 54.762333285502415 10.987907691966827, 54.762333285502415 6.487907794522696, 57.36233328548233 6.487907794522696)), ((35.56233328682164 17.58618339946478, 35.56233328682164 17.787907794145283, 35.76405768116647 17.787907794145244, 35.56233328682164 17.58618339946478)), ((36.86233328692523 22.28790779414441, 36.86233328692523 23.187907793645998, 37.81233338871133 23.187907793645998, 37.81233338871133 23.787907793698544, 39.062333388711316 23.787907793698544, 39.062333388711316 22.28790779414441, 36.86233328692523 22.28790779414441)))')
        assert valid_insertion.ext.similar(expected, area_diff_tol=1e-3)

        self.do_random_assertion(inserter, obstacle, space, valid_insertion)

        # rotation
        inserter = Envelope(geom_or_geoms=box(0, 0, 2, 4).ext.rotate_ccw(origin=(0, 0), angle=45), angle=45)
        insertion = RectInsertion(inserter=inserter)
        obstacle = obstacle.ext.rotate_ccw(origin=(0, 0), angle=45)
        space = box(20, -10, 70, 40).ext.rotate_ccw(origin=(0, 0), angle=45)

        valid_insertions = insertion.of(space=space, obstacle=obstacle)
        valid_insertion = unary_union(valid_insertions)
        assert isinstance(valid_insertions, List)
        assert valid_insertion.ext.similar(expected.ext.rotate_ccw(origin=(0, 0), angle=45),
                                           area_diff_tol=1e-3)
        self.do_random_assertion(inserter, obstacle, space, valid_insertion)

    def do_random_assertion(self, inserter, obstacle, space, valid_insertion, times=2500):
        small_obs = obstacle.ext.rbuf(-1e-3)
        big_obs = obstacle.ext.rbuf(1e-3)
        small_space = space.ext.rbuf(-1e-3)
        big_space = space.ext.rbuf(1e-3)
        for i in range(times):
            p = Point(round(random.uniform(20.1, 69.9), 2), round(random.uniform(-9.9, 39.9), 2))
            vec = Vector.from_origin_to_target(inserter.shape.centroid, p)
            poly: Polygon = vec.apply(inserter.shape)
            if valid_insertion.intersects(p):
                if poly.intersects(small_obs) or not big_space.contains(poly):
                    assert False
            else:
                if not poly.intersects(big_obs) and small_space.contains(poly):
                    assert False

    def test_invalid_space(self):
        inserter = Envelope(geom_or_geoms=box(0, 0, 2, 4), angle=0)
        insertion = RectInsertion(inserter=inserter)

        obstacle = loads(
            'POLYGON ((32.06233328681844 3.637907798731817, 32.06233328681862 2, 32.31233328681866 2, 32.31233328681866 3.3379077987317487, 32.06233328681844 3.637907798731817))')

        invalid = insertion._invalid_insertion(obstacle)
        assert invalid.ext.similar(loads(
            'POLYGON ((33.06233328681844 5.637907798731817, 31.062333286818443 5.637907798731817, 31.062333286818443 1.637907798731817, 31.06233328681862 0, 33.31233328681866 0, 33.31233328681866 5.337907798731749, 33.06233328681844 5.637907798731817))'),
            area_diff_tol=1e-10)
